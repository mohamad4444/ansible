---
- name: Check if preflight has already been run
  stat:
    path: "{{ preflight_marker }}"
  register: preflight_completed

- name: Skip preflight if already completed
  debug:
    msg: "Preflight already completed, skipping tasks. Remove {{ preflight_marker }} to run again."
  when: preflight_completed.stat.exists
  changed_when: false

- name: Run preflight tasks if not already done
  block:
    - name: Verify operating system
      fail:
        msg: "This playbook only supports {{ supported_os }}. Detected OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
      when: ansible_distribution != supported_os

    - name: Backup Rocky repo files
      copy:
        src: /etc/yum.repos.d/
        dest: "{{ repo_backup_dir }}"
        remote_src: true
        mode: preserve
      when: not lookup('ansible.builtin.file', repo_backup_dir, errors='ignore')

    - name: Disable mirrorlist in Rocky repos
      replace:
        path: /etc/yum.repos.d/rocky.repo
        regexp: '^mirrorlist='
        replace: '#mirrorlist='

    - name: Enable baseurl in Rocky repos
      replace:
        path: /etc/yum.repos.d/rocky.repo
        regexp: '^#baseurl='
        replace: 'baseurl='

    - name: Clean DNF cache
      command: dnf clean all
      changed_when: false

    - name: Rebuild DNF cache
      command: dnf makecache
      changed_when: false

    - name: Update all system packages
      dnf:
        name: "*"
        state: latest
        update_cache: yes
      register: package_update

    - name: Check if kernel was updated
      set_fact:
        kernel_updated: "{{ ansible_facts.packages['kernel'] is defined and ansible_facts.packages['kernel'][0].version != ansible_facts.kernel }}"

    - name: Reboot if kernel was updated
      reboot:
        msg: "Rebooting system due to kernel update"
        reboot_timeout: 300
      when: kernel_updated | default(false)

    - name: Wait for system to come back online after reboot
      wait_for_connection:
        delay: 15
        sleep: 5
        timeout: 300
      when: kernel_updated | default(false)

    - name: Create preflight completion marker
      file:
        path: "{{ preflight_marker }}"
        state: touch
        owner: root
        group: root
        mode: '0644'
      changed_when: false

    - name: Display preflight completion message
      debug:
        msg: "Preflight configuration completed successfully. System is ready for further roles."
  when: not preflight_completed.stat.exists

  rescue:
    - name: Display preflight error message
      debug:
        msg: "Preflight configuration failed. Check system requirements and try again."
