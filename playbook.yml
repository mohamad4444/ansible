---
- name: Setup Complete Kubernetes/DevOps Environment on Rocky Linux
  hosts: vps
  become: true
  gather_facts: true
  vars_files:
    - vars.yml
  #  - versions.auto.yml
  
  # Default variable - controls whether to run preflight tasks
  vars:
    run_preflight: true

  tasks:
    - name: Include preflight tasks
      ansible.builtin.include_tasks: preflight.yml
      vars:
        run_preflight: "{{ run_preflight }}"

    - name: Include system packages installation
      ansible.builtin.include_tasks: packages.yml
      when: ansible_distribution == "Rocky"

    - name: Include Docker installation
      ansible.builtin.include_tasks: docker.yml
      when: ansible_distribution == "Rocky"

    - name: Include Kubernetes tools installation
      ansible.builtin.include_tasks: kubernetes.yml
      when: ansible_distribution == "Rocky"

    - name: Include GitOps tools installation
      ansible.builtin.include_tasks: gitops.yml

    - name: Include Cloud tools installation
      ansible.builtin.include_tasks: cloud.yml

    - name: Include Utility tools installation
      ansible.builtin.include_tasks: utilities.yml

    - name: Include environment configuration
      ansible.builtin.include_tasks: environment.yml

    - name: Include cleanup tasks
      ansible.builtin.include_tasks: cleanup.yml
      when: ansible_distribution == "Rocky"

    - name: Include verification tasks
      ansible.builtin.include_tasks: verify.yml