---
- name: Install kubectl aliases
  get_url:
    url: https://raw.githubusercontent.com/ahmetb/kubectl-aliases/master/.kubectl_aliases
    dest: "~{{ ansible_user }}/.kubectl_aliases"
    mode: '0644'

- name: Create .kube directory for current user
  file:
    path: "~{{ ansible_user }}/.kube"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0750'

- name: Create .aws directory for current user
  file:
    path: "~{{ ansible_user }}/.aws"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0700'

- name: Create .kluctl directory for current user
  file:
    path: "~{{ ansible_user }}/.kluctl"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0700'

- name: Configure bashrc for tools
  lineinfile:
    path: "~{{ ansible_user }}/.bashrc"
    line: "{{ item }}"
    create: yes
  with_items:
    - 'export PATH=$PATH:/usr/local/bin:/usr/local/go/bin:$HOME/.local/bin'
    - 'export KUBECONFIG=$HOME/.kube/config'
    - 'export MINIKUBE_DRIVER=docker'
    - 'export EDITOR=vim'
    - 'alias k="kubectl"'
    - 'alias kc="kubectl"'
    - 'alias kd="kubectl describe"'
    - 'alias kg="kubectl get"'
    - 'alias kl="kubectl logs"'
    - 'alias kaf="kubectl apply -f"'
    - 'alias kdf="kubectl delete -f"'
    - 'alias kgp="kubectl get pods"'
    - 'alias kgn="kubectl get nodes"'
    - 'alias kdp="kubectl describe pod"'
    - 'alias kdd="kubectl describe deployment"'
    - 'alias kds="kubectl describe service"'
    - 'alias stern="stern --tail 10"'
    - 'alias dc="docker-compose"'
    - 'alias d="docker"'
    - 'alias tf="terraform"'
    - 'alias h="helm"'
    - 'alias hf="helmfile"'
    - 'alias kctl="kluctl"'
    - 'source /etc/bash_completion'
    - 'source <(kubectl completion bash)'
    - 'source <(helm completion bash)'
    - 'source <(kluctl completion bash)'
    - '[[ -f ~/.kubectl_aliases ]] && source ~/.kubectl_aliases'
    - 'complete -o default -F __start_kubectl k'

- name: Add Kubernetes helper functions
  copy:
    dest: "~{{ ansible_user }}/.k8s-helpers.sh"
    content: |
      #!/bin/bash
      
      # Kubernetes helper functions
      kexec() {
        local pod=$(kubectl get pods -n ${2:-default} | grep $1 | head -1 | awk '{print $1}')
        kubectl exec -it $pod -n ${2:-default} -- ${3:-bash}
      }
      
      klogs() {
        local pod=$(kubectl get pods -n ${2:-default} | grep $1 | head -1 | awk '{print $1}')
        kubectl logs -f $pod -n ${2:-default}
      }
      
      kport() {
        kubectl port-forward $1 ${2:-8080}:${3:-8080} -n ${4:-default}
      }
      
      kclean() {
        kubectl delete pod --field-selector=status.phase==Succeeded -A
        kubectl delete pod --field-selector=status.phase==Failed -A
      }
      
      # Kluctl helper functions
      kluctl-deploy() {
        kluctl deploy -t $1 --yes
      }
      
      kluctl-diff() {
        kluctl diff -t $1
      }
      
      kluctl-validate() {
        kluctl validate -t $1
      }
      
      kluctl-prune() {
        kluctl prune -t $1 --yes
      }
      
      # Cluster management
      cluster-info() {
        echo "Current Context:"
        kubectl config current-context
        echo ""
        echo "Cluster Info:"
        kubectl cluster-info
        echo ""
        echo "Nodes:"
        kubectl get nodes -o wide
        echo ""
        echo "Namespaces:"
        kubectl get namespaces
      }
      
      # Resource monitoring
      watch-pods() {
        watch -n 2 "kubectl get pods -A --sort-by='.metadata.creationTimestamp'"
      }
      
      watch-nodes() {
        watch -n 5 "kubectl get nodes -o wide"
      }
      
      # Debug functions
      pod-details() {
        kubectl describe pod $1 -n ${2:-default}
      }
      
      pod-yaml() {
        kubectl get pod $1 -n ${2:-default} -o yaml
      }
      
      # Secret decoding
      decode-secret() {
        kubectl get secret $1 -n ${2:-default} -o jsonpath="{.data.$3}" | base64 --decode
      }
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Source k8s helpers in bashrc
  lineinfile:
    path: "~{{ ansible_user }}/.bashrc"
    line: '[[ -f ~/.k8s-helpers.sh ]] && source ~/.k8s-helpers.sh'

- name: Create ~/.bash_profile if it doesn't exist
  file:
    path: "~{{ ansible_user }}/.bash_profile"
    state: touch
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Source bashrc from bash_profile
  lineinfile:
    path: "~{{ ansible_user }}/.bash_profile"
    line: '[[ -f ~/.bashrc ]] && . ~/.bashrc'

- name: Create example Kluctl project directory
  file:
    path: "~{{ ansible_user }}/projects/kluctl-example"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Create Kluctl example README
  copy:
    dest: "~{{ ansible_user }}/projects/kluctl-example/README.md"
    content: |
      # Kluctl Example Project
      
      This is an example Kluctl project structure.
      
      Quick Start:
      
      1. Initialize a new project:
      kluctl create project my-project
      
      2. Deploy to cluster:
      kluctl deploy -t dev --yes
      
      3. Check diff:
      kluctl diff -t dev
      
      4. Validate deployment:
      kluctl validate -t dev
      
      Common Commands:
      
      - kluctl deploy -t <target> - Deploy to target environment
      - kluctl diff -t <target> - Show diff between local and cluster
      - kluctl prune -t <target> - Prune orphaned resources
      - kluctl helm-update - Update Helm charts
      - kluctl list-images -t <target> - List images used in deployment
      
      Project Structure:
      
      .kluctl.yml       # Kluctl configuration
      .kluctl/          # Target definitions
        dev.yml
        staging.yml
        prod.yml
      deployments/      # Deployment configurations
        my-app/
          kustomization.yml
          deployment.yml
          service.yml
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"