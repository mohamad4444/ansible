---
- name: Download Helm binary
  get_url:
    url: "https://get.helm.sh/helm-v{{ helm_version }}-linux-{{ architecture }}.tar.gz"
    dest: /tmp/helm.tar.gz

- name: Extract and install Helm
  unarchive:
    src: /tmp/helm.tar.gz
    dest: /tmp
    remote_src: yes
    creates: "/tmp/linux-{{ architecture }}/helm"

- name: Move Helm binary to /usr/local/bin
  copy:
    src: "/tmp/linux-{{ architecture }}/helm"
    dest: /usr/local/bin/helm
    mode: '0755'
    remote_src: yes

- name: Install Helm bash completion
  command: /usr/local/bin/helm completion bash
  register: helm_completion

- name: Write Helm bash completion
  copy:
    content: "{{ helm_completion.stdout }}"
    dest: /etc/bash_completion.d/helm
    mode: '0644'

- name: Download Helmfile binary
  get_url:
    url: "https://github.com/helmfile/helmfile/releases/download/v{{ helmfile_version }}/helmfile_{{ helmfile_version }}_linux_{{ architecture }}.tar.gz"
    dest: /tmp/helmfile.tar.gz

- name: Extract and install Helmfile
  unarchive:
    src: /tmp/helmfile.tar.gz
    dest: /usr/local/bin
    remote_src: yes


- name: Set executable permission for Helmfile
  file:
    path: /usr/local/bin/helmfile
    mode: '0755'

- name: Download Kluctl archive
  get_url:
    url: "https://github.com/kluctl/kluctl/releases/download/v{{ kluctl_version }}/kluctl_v{{ kluctl_version }}_linux_{{ architecture }}.tar.gz"
    dest: /tmp/kluctl.tar.gz

- name: Extract Kluctl
  unarchive:
    src: /tmp/kluctl.tar.gz
    dest: /usr/local/bin
    remote_src: yes

- name: Ensure Kluctl is executable
  file:
    path: /usr/local/bin/kluctl
    mode: '0755'

- name: Install Kluctl bash completion
  shell: /usr/local/bin/kluctl completion bash > /etc/bash_completion.d/kluctl


- name: Download kustomize archive
  get_url:
    url: "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv{{ kustomize_version }}/kustomize_v{{ kustomize_version }}_linux_{{ architecture }}.tar.gz"
    dest: /tmp/kustomize.tar.gz

- name: Extract kustomize
  unarchive:
    src: /tmp/kustomize.tar.gz
    dest: /usr/local/bin
    remote_src: yes



- name: Download tilt binary
  get_url:
    url: "https://github.com/tilt-dev/tilt/releases/download/v{{ tilt_version }}/tilt.{{ tilt_version }}.linux.{{ 'x86_64' if ansible_architecture == 'x86_64' else 'arm64' }}.tar.gz"
    dest: /tmp/tilt.tar.gz

- name: Extract and install tilt
  unarchive:
    src: /tmp/tilt.tar.gz
    dest: /usr/local/bin
    remote_src: yes
    extra_opts: [--strip-components=1]

- name: Download ArgoCD CLI
  get_url:
    url: "https://github.com/argoproj/argo-cd/releases/download/v{{ argocd_version }}/argocd-linux-{{ architecture }}"
    dest: /usr/local/bin/argocd
    mode: '0755'